<!DOCTYPE html>
<html lang="es">
<!--
    📋 ASISTENTE PERSONAL - PARTE DIARIO DE TRABAJO - VERSIÓN COMPLETA 2.0

    ✅ CARACTERÍSTICAS IMPLEMENTADAS:
    • Formulario completo en 8 pasos
    • Dictado por voz integrado
    • Guardado local automático
    • Envío a Google Sheets
    • Exportación completa a CSV
    • Subida de imágenes y documentos
    • Modal de partes guardados
    • Modal "Acerca de"
    • Interfaz responsive con Tailwind CSS

    🛠️ TECNOLOGÍAS:
    • React 18 + Hooks
    • Tailwind CSS
    • Web Speech API
    • Google Apps Script
    • Local Storage
    • File API

    👨‍💻 Desarrollado por: Michel Soler
    📅 Fecha: 2024
    🏗️ Especializado para construcción y mantenimiento
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📋 Asistente Personal - Parte Diario de Trabajo</title>
    <meta name="description" content="Asistente personal para gestión de partes diarios de trabajo con dictado por voz y envío a Google Sheets">
    <meta name="keywords" content="parte diario, trabajo, dictado voz, construcción, mantenimiento">
    <meta name="author" content="Michel Soler">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="90" font-size="90">📋</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>

    <!-- Babel para transformar JSX -->
    <script src="https://unpkg.com/@babel/standalone@7.23.4/babel.min.js"></script>

    <style>
        /* Animaciones personalizadas */
        @keyframes pulse-custom {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-custom {
            animation: pulse-custom 1s ease-in-out infinite;
        }

        /* Estilos para el scroll personalizado */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Mejoras para pantallas pequeñas */
        @media (max-width: 640px) {
            .container-mobile {
                padding: 1rem;
            }
        }

        /* Estilos para el dictado por voz */
        .voice-active {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            animation: pulse-custom 1s ease-in-out infinite;
        }

        /* Iconos emoji */
        .icon {
            display: inline-block;
            font-size: 16px;
            width: 16px;
            height: 16px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root" class="min-h-screen">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Cargando Asistente Personal...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Componentes de iconos usando emojis
        const FileText = () => <span className="icon">📄</span>;
        const Calendar = () => <span className="icon">📅</span>;
        const Users = () => <span className="icon">👥</span>;
        const Package = () => <span className="icon">📦</span>;
        const AlertTriangle = () => <span className="icon">⚠️</span>;
        const Clock = () => <span className="icon">⏰</span>;
        const Camera = () => <span className="icon">📷</span>;
        const Brain = () => <span className="icon">🧠</span>;
        const Mic = () => <span className="icon">🎤</span>;
        const MicOff = () => <span className="icon">🔇</span>;

        const ParteDiarioTrabajo = () => {
            // ========== ESTADO PRINCIPAL ==========
            const [currentStep, setCurrentStep] = useState(0);
            const [isListening, setIsListening] = useState(false);
            const [savedParts, setSavedParts] = useState([]);
            const [showSavedParts, setShowSavedParts] = useState(false);
            const [showConfig, setShowConfig] = useState(false);
            const [showAbout, setShowAbout] = useState(false);

            // Estado para configuración de Google Apps Script
            const [googleScriptUrl, setGoogleScriptUrl] = useState('');

            // Estado del formulario
            const [formData, setFormData] = useState({
                nombreTrabajo: '',
                fecha: new Date().toISOString().split('T')[0],
                operarios: [{ nombre: '', horas: '' }],
                trabajosRealizados: '',
                materialesUtilizados: '',
                incidencias: '',
                observaciones: '',
                tareasPendientes: '',
                imagenes: [],
                albaranes: []
            });

            // Referencias para el dictado por voz
            const recognitionRef = useRef(null);
            const isRecognitionSupported = useRef(false);

            // ========== EFECTOS DE INICIALIZACIÓN ==========
            useEffect(() => {
                // Cargar datos guardados del localStorage
                const saved = localStorage.getItem('partes_diarios');
                if (saved) {
                    setSavedParts(JSON.parse(saved));
                }

                // Cargar configuración de Google Apps Script
                const savedScriptUrl = localStorage.getItem('google_script_url');
                if (savedScriptUrl) {
                    setGoogleScriptUrl(savedScriptUrl);
                }

                // Configurar reconocimiento de voz
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.interimResults = false;
                    recognitionRef.current.lang = 'es-ES';
                    isRecognitionSupported.current = true;

                    recognitionRef.current.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        appendToCurrentField(transcript);
                    };

                    recognitionRef.current.onend = () => {
                        setIsListening(false);
                    };

                    recognitionRef.current.onerror = () => {
                        setIsListening(false);
                        alert('Error en el reconocimiento de voz. Inténtalo de nuevo.');
                    };
                }
            }, []);

            // ========== FUNCIONES DE UTILIDAD ==========
            const appendToCurrentField = (text) => {
                const fieldMap = {
                    0: 'nombreTrabajo',
                    2: 'trabajosRealizados',
                    3: 'materialesUtilizados',
                    4: 'incidencias',
                    5: 'observaciones',
                    6: 'tareasPendientes'
                };

                const field = fieldMap[currentStep];
                if (field) {
                    setFormData(prev => ({
                        ...prev,
                        [field]: prev[field] + (prev[field] ? ' ' : '') + text
                    }));
                }
            };

            const startListening = () => {
                if (recognitionRef.current && isRecognitionSupported.current) {
                    setIsListening(true);
                    recognitionRef.current.start();
                }
            };

            const stopListening = () => {
                if (recognitionRef.current) {
                    recognitionRef.current.stop();
                }
            };

            const addOperario = () => {
                setFormData(prev => ({
                    ...prev,
                    operarios: [...prev.operarios, { nombre: '', horas: '' }]
                }));
            };

            const removeOperario = (index) => {
                if (formData.operarios.length > 1) {
                    setFormData(prev => ({
                        ...prev,
                        operarios: prev.operarios.filter((_, i) => i !== index)
                    }));
                }
            };

            const updateOperario = (index, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    operarios: prev.operarios.map((op, i) =>
                        i === index ? { ...op, [field]: value } : op
                    )
                }));
            };

            // ========== MANEJO DE ARCHIVOS ==========
            const handleFileUpload = (files, type) => {
                const fileArray = Array.from(files);
                fileArray.forEach(file => {
                    if (file.size > 10 * 1024 * 1024) { // 10MB limit
                        alert(`El archivo ${file.name} es demasiado grande. Máximo 10MB.`);
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const newFile = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            url: e.target.result,
                            timestamp: new Date().toISOString()
                        };

                        setFormData(prev => ({
                            ...prev,
                            [type]: [...prev[type], newFile]
                        }));
                    };
                    reader.readAsDataURL(file);
                });
            };

            const removeFile = (index, type) => {
                setFormData(prev => ({
                    ...prev,
                    [type]: prev[type].filter((_, i) => i !== index)
                }));
            };

            // ========== FUNCIONES DE GUARDADO Y ENVÍO ==========
            const savePartLocally = () => {
                const totalHoras = formData.operarios.reduce((sum, op) => sum + (parseFloat(op.horas) || 0), 0);

                if (!formData.nombreTrabajo.trim()) {
                    alert('⚠️ El nombre del trabajo es obligatorio');
                    return false;
                }

                const partData = {
                    ...formData,
                    totalHoras,
                    timestamp: new Date().toISOString(),
                    id: Date.now()
                };

                const updatedParts = [...savedParts, partData];
                setSavedParts(updatedParts);
                localStorage.setItem('partes_diarios', JSON.stringify(updatedParts));

                return true;
            };

            const sendToGoogleSheets = async () => {
                if (!googleScriptUrl.trim()) {
                    alert('⚠️ Primero configura la URL de Google Apps Script en Configuración');
                    return false;
                }

                // Mostrar indicador de carga
                const loadingAlert = document.createElement('div');
                loadingAlert.innerHTML = `
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                                z-index: 10000; text-align: center;">
                        <div style="font-size: 18px; margin-bottom: 10px;">📊 Enviando a Google Sheets...</div>
                        <div style="font-size: 14px; color: #666;">Guardando en base de datos...</div>
                    </div>
                `;
                document.body.appendChild(loadingAlert);

                try {
                    // Calcular total de horas
                    const totalHoras = formData.operarios?.reduce((sum, op) => sum + (parseFloat(op.horas) || 0), 0) || 0;

                    // Preparar información de imágenes y albaranes
                    const imagenesInfo = (formData.imagenes || []).length > 0
                        ? `📷 ${formData.imagenes.length} imagen(es): ${formData.imagenes.map(img => img.name).join(', ')}`
                        : 'Sin imágenes';

                    const albaranesInfo = (formData.albaranes || []).length > 0
                        ? `📄 ${formData.albaranes.length} albarán(es): ${formData.albaranes.map(alb => alb.name).join(', ')}`
                        : 'Sin albaranes';

                    // Preparar datos para Google Apps Script con todos los campos del formulario completo
                    const dataToSend = {
                        // Información básica
                        nombreTrabajo: formData.nombreTrabajo || 'Sin especificar',
                        fecha: formData.fecha || new Date().toISOString().split('T')[0],
                        timestamp: new Date().toISOString(),

                        // Información de operarios
                        totalHoras: totalHoras.toString(),
                        numOperarios: (formData.operarios?.length || 0).toString(),
                        listaOperarios: formData.operarios?.map(op => `${op.nombre}: ${op.horas}h`).join(', ') || 'Sin operarios',

                        // Contenido del trabajo (pasos 3-6)
                        trabajosRealizados: formData.trabajosRealizados || 'Sin especificar',
                        materialesUtilizados: formData.materialesUtilizados || 'Sin materiales',
                        incidencias: formData.incidencias || 'Sin incidencias',
                        observaciones: formData.observaciones || 'Sin observaciones',
                        tareasPendientes: formData.tareasPendientes || 'Sin tareas pendientes',

                        // Información de archivos adjuntos
                        infoImagenes: imagenesInfo,
                        infoAlbaranes: albaranesInfo,
                        numImagenes: (formData.imagenes || []).length.toString(),
                        numAlbaranes: (formData.albaranes || []).length.toString()
                    };

                    console.log('📊 ENVIANDO A GOOGLE APPS SCRIPT:', dataToSend);

                    // Crear URL con parámetros GET
                    const params = new URLSearchParams(dataToSend);
                    const getUrl = `${googleScriptUrl}?${params.toString()}`;

                    console.log('🔗 URL completa:', getUrl);

                    // Enviar datos usando GET con mode no-cors
                    const response = await fetch(getUrl, {
                        method: 'GET',
                        mode: 'no-cors'
                    });

                    console.log('📊 Petición enviada con éxito');

                    // Quitar indicador de carga
                    if (loadingAlert.parentNode) {
                        document.body.removeChild(loadingAlert);
                    }

                    // Mostrar confirmación
                    let mensaje = '📤 ¡Datos enviados a Google Sheets!\\n\\n';
                    mensaje += '📊 Verifica en tu hoja de cálculo si los datos llegaron\\n';
                    mensaje += '\\n🔗 Ver datos: https://docs.google.com/spreadsheets/d/1-BnjLpKsrUS5DdDmAEn16eEp9Uqs97cNpr_a7CScwfo';
                    mensaje += '\\n\\n💡 Base de datos profesional lista para análisis!';

                    alert(mensaje);
                    return true;

                } catch (error) {
                    console.error('Error enviando a Google Sheets:', error);

                    // Quitar indicador de carga
                    if (loadingAlert.parentNode) {
                        document.body.removeChild(loadingAlert);
                    }

                    alert('❌ Error enviando a Google Sheets\\n\\n' + error.message + '\\n\\nPero el parte se ha guardado localmente.');
                    return false;
                }
            };

            const saveAndSend = async () => {
                // Primero guardar localmente
                const localSaved = savePartLocally();
                if (!localSaved) return;

                // Luego intentar enviar a Google Sheets
                await sendToGoogleSheets();

                // Resetear formulario después del envío
                setFormData({
                    nombreTrabajo: '',
                    fecha: new Date().toISOString().split('T')[0],
                    operarios: [{ nombre: '', horas: '' }],
                    trabajosRealizados: '',
                    materialesUtilizados: '',
                    incidencias: '',
                    observaciones: '',
                    tareasPendientes: '',
                    imagenes: [],
                    albaranes: []
                });
                setCurrentStep(0);

                alert('✅ Parte guardado exitosamente!\\n\\nPuedes crear un nuevo parte.');
            };

            // ========== FUNCIONES DE CONFIGURACIÓN ==========
            const saveGoogleScriptUrl = (url) => {
                setGoogleScriptUrl(url);
                localStorage.setItem('google_script_url', url);
            };

            const testConnection = () => {
                if (!googleScriptUrl.trim()) {
                    alert('⚠️ Primero configura la URL del Google Apps Script');
                    return;
                }

                // Datos de prueba para Google Apps Script
                const testData = {
                    nombreTrabajo: 'TEST - Prueba de conexión',
                    fecha: new Date().toISOString().split('T')[0],
                    totalHoras: '8',
                    numOperarios: '1',
                    listaOperarios: 'Usuario Test: 8h',
                    trabajosRealizados: 'Prueba de conexión con Google Apps Script',
                    materialesUtilizados: 'Ninguno',
                    incidencias: '',
                    observaciones: 'Prueba realizada desde configuración',
                    tareasPendientes: '',
                    infoImagenes: 'Sin imágenes',
                    infoAlbaranes: 'Sin albaranes'
                };

                // Crear URL con parámetros GET
                const params = new URLSearchParams(testData);
                const testUrl = `${googleScriptUrl}?${params.toString()}`;

                alert('🧪 Enviando datos de prueba...\\n\\nSe abrirá una nueva pestaña con el resultado.\\n\\nSi ves un JSON con "status": "success", ¡la conexión funciona!');

                // Abrir en nueva pestaña
                window.open(testUrl, '_blank');
            };

            // ========== FUNCIONES DE EXPORTACIÓN ==========
            const exportToCSV = () => {
                if (savedParts.length === 0) {
                    alert('❌ No hay partes guardados para exportar');
                    return;
                }

                // Crear encabezados del CSV con todos los campos
                const headers = [
                    'Fecha Guardado',
                    'ID Parte',
                    'Nombre Trabajo',
                    'Fecha Trabajo',
                    'Total Horas',
                    'Num Operarios',
                    'Lista Operarios',
                    'Trabajos Realizados',
                    'Materiales Utilizados',
                    'Incidencias',
                    'Observaciones',
                    'Tareas Pendientes',
                    'Num Imágenes',
                    'Nombres Imágenes',
                    'Num Albaranes',
                    'Nombres Albaranes'
                ];

                let csvContent = headers.join(',') + '\\n';

                savedParts.forEach(parte => {
                    // Limpiar y escapar datos
                    const cleanText = (text) => {
                        if (!text) return '';
                        return `"${text.toString().replace(/"/g, '""').replace(/\\n/g, ' ').replace(/\\r/g, ' ')}"`;
                    };

                    const imageNames = parte.imagenes?.map(img => img.name).join('; ') || '';
                    const albaranNames = parte.albaranes?.map(alb => alb.name).join('; ') || '';
                    const operariosList = parte.operarios?.map(op => `${op.nombre}: ${op.horas}h`).join('; ') || '';

                    const row = [
                        cleanText(new Date(parte.timestamp).toLocaleString('es-ES')),
                        cleanText(parte.id || ''),
                        cleanText(parte.nombreTrabajo || ''),
                        cleanText(parte.fecha || ''),
                        parte.totalHoras || 0,
                        parte.operarios?.length || 0,
                        cleanText(operariosList),
                        cleanText(parte.trabajosRealizados || ''),
                        cleanText(parte.materialesUtilizados || ''),
                        cleanText(parte.incidencias || ''),
                        cleanText(parte.observaciones || ''),
                        cleanText(parte.tareasPendientes || ''),
                        parte.imagenes?.length || 0,
                        cleanText(imageNames),
                        parte.albaranes?.length || 0,
                        cleanText(albaranNames)
                    ];

                    csvContent += row.join(',') + '\\n';
                });

                // Crear y descargar archivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');

                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    const fecha = new Date().toISOString().split('T')[0];
                    const fileName = `partes_diarios_completo_${fecha}.csv`;

                    link.setAttribute('href', url);
                    link.setAttribute('download', fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Limpiar URL
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                }

                // Mostrar resumen de exportación
                const mensaje = `📊 CSV exportado exitosamente\\n\\n` +
                               `📁 Archivo: partes_diarios_completo_${new Date().toISOString().split('T')[0]}.csv\\n` +
                               `📋 Registros: ${savedParts.length} partes\\n` +
                               `📊 Campos: ${headers.length} columnas\\n\\n` +
                               `✅ Compatible con Excel, Google Sheets y cualquier aplicación de hojas de cálculo\\n\\n` +
                               `💡 El archivo incluye todos los datos: operarios, trabajos, materiales, incidencias, observaciones, tareas pendientes y archivos adjuntos`;

                alert(mensaje);
            };

            // ========== RENDERIZADO DE PASOS ==========
            const renderStep = () => {
                const steps = [
                    // Paso 0: Nombre del trabajo
                    <div key="0" className="space-y-4">
                        <div className="text-center">
                            <FileText />
                            <h2 className="text-xl font-bold mt-2">Nombre del Trabajo</h2>
                            <p className="text-gray-600">¿En qué proyecto estás trabajando?</p>
                        </div>
                        <div className="relative">
                            <input
                                type="text"
                                value={formData.nombreTrabajo}
                                onChange={(e) => setFormData({...formData, nombreTrabajo: e.target.value})}
                                placeholder="Ej: Instalación eléctrica edificio A"
                                className="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                autoFocus
                            />
                            {isRecognitionSupported.current && (
                                <button
                                    onClick={isListening ? stopListening : startListening}
                                    className={`absolute right-3 top-1/2 transform -translate-y-1/2 p-2 rounded-full ${
                                        isListening ? 'bg-red-500 text-white voice-active' : 'bg-gray-200 hover:bg-gray-300'
                                    }`}
                                >
                                    {isListening ? <MicOff /> : <Mic />}
                                </button>
                            )}
                        </div>
                    </div>,

                    // Paso 1: Fecha y Operarios
                    <div key="1" className="space-y-6">
                        <div className="text-center">
                            <Calendar />
                            <h2 className="text-xl font-bold mt-2">Fecha y Operarios</h2>
                            <p className="text-gray-600">Información básica del parte</p>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    <Calendar /> Fecha del trabajo
                                </label>
                                <input
                                    type="date"
                                    value={formData.fecha}
                                    onChange={(e) => setFormData({...formData, fecha: e.target.value})}
                                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    <Users /> Operarios
                                </label>
                                {formData.operarios.map((operario, index) => (
                                    <div key={index} className="flex gap-2 mb-2">
                                        <input
                                            type="text"
                                            placeholder="Nombre del operario"
                                            value={operario.nombre}
                                            onChange={(e) => updateOperario(index, 'nombre', e.target.value)}
                                            className="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                        />
                                        <input
                                            type="number"
                                            placeholder="Horas"
                                            value={operario.horas}
                                            onChange={(e) => updateOperario(index, 'horas', e.target.value)}
                                            className="w-20 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                            step="0.5"
                                            min="0"
                                        />
                                        {formData.operarios.length > 1 && (
                                            <button
                                                onClick={() => removeOperario(index)}
                                                className="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
                                            >
                                                ❌
                                            </button>
                                        )}
                                    </div>
                                ))}
                                <button
                                    onClick={addOperario}
                                    className="w-full p-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-gray-400"
                                >
                                    + Añadir operario
                                </button>
                                <div className="text-sm text-gray-600 mt-2">
                                    Total horas: {formData.operarios.reduce((sum, op) => sum + (parseFloat(op.horas) || 0), 0)}
                                </div>
                            </div>
                        </div>
                    </div>,

                    // Paso 2: Trabajos realizados
                    <div key="2" className="space-y-4">
                        <div className="text-center">
                            <Package />
                            <h2 className="text-xl font-bold mt-2">Trabajos Realizados</h2>
                            <p className="text-gray-600">Describe los trabajos realizados durante la jornada</p>
                        </div>
                        <div className="relative">
                            <textarea
                                value={formData.trabajosRealizados}
                                onChange={(e) => setFormData({...formData, trabajosRealizados: e.target.value})}
                                placeholder="Ej: Instalación de tubería en planta baja, conexión de cuadro eléctrico..."
                                className="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none h-32 resize-none"
                                autoFocus
                            />
                            {isRecognitionSupported.current && (
                                <button
                                    onClick={isListening ? stopListening : startListening}
                                    className={`absolute right-3 top-3 p-2 rounded-full ${
                                        isListening ? 'bg-red-500 text-white voice-active' : 'bg-gray-200 hover:bg-gray-300'
                                    }`}
                                >
                                    {isListening ? <MicOff /> : <Mic />}
                                </button>
                            )}
                        </div>
                        <div className="text-sm text-gray-500">
                            💡 Tip: Sé específico sobre las tareas completadas, materiales utilizados y tiempos empleados
                        </div>
                    </div>,

                    // Paso 3: Materiales utilizados
                    <div key="3" className="space-y-4">
                        <div className="text-center">
                            <Package />
                            <h2 className="text-xl font-bold mt-2">Materiales Utilizados</h2>
                            <p className="text-gray-600">Lista los materiales y herramientas empleados</p>
                        </div>
                        <div className="relative">
                            <textarea
                                value={formData.materialesUtilizados}
                                onChange={(e) => setFormData({...formData, materialesUtilizados: e.target.value})}
                                placeholder="Ej: 20m cable 2.5mm, 5 enchufes, taladro, nivel láser..."
                                className="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none h-32 resize-none"
                                autoFocus
                            />
                            {isRecognitionSupported.current && (
                                <button
                                    onClick={isListening ? stopListening : startListening}
                                    className={`absolute right-3 top-3 p-2 rounded-full ${
                                        isListening ? 'bg-red-500 text-white voice-active' : 'bg-gray-200 hover:bg-gray-300'
                                    }`}
                                >
                                    {isListening ? <MicOff /> : <Mic />}
                                </button>
                            )}
                        </div>
                        <div className="text-sm text-gray-500">
                            💡 Tip: Incluye cantidades, marcas y referencias cuando sea posible
                        </div>
                    </div>,

                    // Paso 4: Incidencias
                    <div key="4" className="space-y-4">
                        <div className="text-center">
                            <AlertTriangle />
                            <h2 className="text-xl font-bold mt-2">Incidencias</h2>
                            <p className="text-gray-600">Registra cualquier problema o situación inesperada</p>
                        </div>
                        <div className="relative">
                            <textarea
                                value={formData.incidencias}
                                onChange={(e) => setFormData({...formData, incidencias: e.target.value})}
                                placeholder="Ej: Retraso por lluvia, material defectuoso, problema con acceso..."
                                className="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none h-32 resize-none"
                                autoFocus
                            />
                            {isRecognitionSupported.current && (
                                <button
                                    onClick={isListening ? stopListening : startListening}
                                    className={`absolute right-3 top-3 p-2 rounded-full ${
                                        isListening ? 'bg-red-500 text-white voice-active' : 'bg-gray-200 hover:bg-gray-300'
                                    }`}
                                >
                                    {isListening ? <MicOff /> : <Mic />}
                                </button>
                            )}
                        </div>
                        <div className="text-sm text-gray-500">
                            💡 Tip: Si no hubo incidencias, puedes dejar este campo vacío
                        </div>
                    </div>,

                    // Paso 5: Observaciones
                    <div key="5" className="space-y-4">
                        <div className="text-center">
                            <Brain />
                            <h2 className="text-xl font-bold mt-2">Observaciones</h2>
                            <p className="text-gray-600">Comentarios adicionales y notas importantes</p>
                        </div>
                        <div className="relative">
                            <textarea
                                value={formData.observaciones}
                                onChange={(e) => setFormData({...formData, observaciones: e.target.value})}
                                placeholder="Ej: Cliente satisfecho con el trabajo, necesario coordinar con electricista..."
                                className="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none h-32 resize-none"
                                autoFocus
                            />
                            {isRecognitionSupported.current && (
                                <button
                                    onClick={isListening ? stopListening : startListening}
                                    className={`absolute right-3 top-3 p-2 rounded-full ${
                                        isListening ? 'bg-red-500 text-white voice-active' : 'bg-gray-200 hover:bg-gray-300'
                                    }`}
                                >
                                    {isListening ? <MicOff /> : <Mic />}
                                </button>
                            )}
                        </div>
                        <div className="text-sm text-gray-500">
                            💡 Tip: Incluye información útil para futuros trabajos o el seguimiento del proyecto
                        </div>
                    </div>,

                    // Paso 6: Tareas pendientes
                    <div key="6" className="space-y-4">
                        <div className="text-center">
                            <Clock />
                            <h2 className="text-xl font-bold mt-2">Tareas Pendientes</h2>
                            <p className="text-gray-600">Lista las tareas que quedan por realizar</p>
                        </div>
                        <div className="relative">
                            <textarea
                                value={formData.tareasPendientes}
                                onChange={(e) => setFormData({...formData, tareasPendientes: e.target.value})}
                                placeholder="Ej: Completar instalación segundo piso, revisión final de conexiones..."
                                className="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none h-32 resize-none"
                                autoFocus
                            />
                            {isRecognitionSupported.current && (
                                <button
                                    onClick={isListening ? stopListening : startListening}
                                    className={`absolute right-3 top-3 p-2 rounded-full ${
                                        isListening ? 'bg-red-500 text-white voice-active' : 'bg-gray-200 hover:bg-gray-300'
                                    }`}
                                >
                                    {isListening ? <MicOff /> : <Mic />}
                                </button>
                            )}
                        </div>
                        <div className="text-sm text-gray-500">
                            💡 Tip: Organiza las tareas por prioridad o fecha estimada de realización
                        </div>
                    </div>,

                    // Paso 7: Archivos (imágenes y albaranes)
                    <div key="7" className="space-y-6">
                        <div className="text-center">
                            <Camera />
                            <h2 className="text-xl font-bold mt-2">Archivos Adjuntos</h2>
                            <p className="text-gray-600">Sube imágenes del trabajo y albaranes</p>
                        </div>

                        {/* Sección de imágenes */}
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    <Camera /> Imágenes del trabajo
                                </label>
                                <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
                                    <input
                                        type="file"
                                        multiple
                                        accept="image/*"
                                        onChange={(e) => handleFileUpload(e.target.files, 'imagenes')}
                                        className="hidden"
                                        id="imagenes-upload"
                                    />
                                    <label htmlFor="imagenes-upload" className="cursor-pointer">
                                        <Camera />
                                        <p className="mt-2 text-sm text-gray-600">
                                            Haz clic para seleccionar imágenes o arrastra aquí
                                        </p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            Máximo 10MB por archivo
                                        </p>
                                    </label>
                                </div>

                                {/* Vista previa de imágenes */}
                                {formData.imagenes.length > 0 && (
                                    <div className="mt-4">
                                        <h4 className="text-sm font-medium text-gray-700 mb-2">
                                            Imágenes seleccionadas ({formData.imagenes.length})
                                        </h4>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            {formData.imagenes.map((imagen, index) => (
                                                <div key={index} className="relative group">
                                                    <img
                                                        src={imagen.url}
                                                        alt={imagen.name}
                                                        className="w-full h-24 object-cover rounded-lg border"
                                                    />
                                                    <button
                                                        onClick={() => removeFile(index, 'imagenes')}
                                                        className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                                                    >
                                                        ❌
                                                    </button>
                                                    <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-75 text-white text-xs p-1 rounded-b-lg truncate">
                                                        {imagen.name}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Sección de albaranes */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    📄 Albaranes y documentos
                                </label>
                                <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
                                    <input
                                        type="file"
                                        multiple
                                        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                        onChange={(e) => handleFileUpload(e.target.files, 'albaranes')}
                                        className="hidden"
                                        id="albaranes-upload"
                                    />
                                    <label htmlFor="albaranes-upload" className="cursor-pointer">
                                        <span className="icon">📄</span>
                                        <p className="mt-2 text-sm text-gray-600">
                                            Selecciona albaranes, facturas o documentos
                                        </p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            PDF, imágenes o documentos (máximo 10MB)
                                        </p>
                                    </label>
                                </div>

                                {/* Lista de albaranes */}
                                {formData.albaranes.length > 0 && (
                                    <div className="mt-4">
                                        <h4 className="text-sm font-medium text-gray-700 mb-2">
                                            Documentos seleccionados ({formData.albaranes.length})
                                        </h4>
                                        <div className="space-y-2">
                                            {formData.albaranes.map((albaran, index) => (
                                                <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                                                    <div className="flex items-center space-x-3">
                                                        <span className="icon">📄</span>
                                                        <div>
                                                            <p className="text-sm font-medium text-gray-700 truncate">
                                                                {albaran.name}
                                                            </p>
                                                            <p className="text-xs text-gray-500">
                                                                {(albaran.size / 1024 / 1024).toFixed(2)} MB
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() => removeFile(index, 'albaranes')}
                                                        className="text-red-500 hover:text-red-700 p-1"
                                                    >
                                                        ❌
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="text-sm text-gray-500 bg-blue-50 p-4 rounded-lg">
                            💡 Tip: Las imágenes y documentos se guardan localmente. Para enviarlos a Google Sheets,
                            se incluirá información sobre los archivos adjuntos en el registro.
                        </div>
                    </div>
                ];

                return steps[currentStep] || null;
            };

            // ========== RENDERIZADO PRINCIPAL ==========
            // Modal para mostrar partes guardados
            if (showSavedParts) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
                            <div className="flex justify-between items-center p-6 border-b">
                                <h2 className="text-2xl font-bold">📋 Partes Guardados ({savedParts.length})</h2>
                                <div className="flex gap-2">
                                    <button
                                        onClick={exportToCSV}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        disabled={savedParts.length === 0}
                                    >
                                        📊 Exportar CSV
                                    </button>
                                    <button
                                        onClick={() => setShowSavedParts(false)}
                                        className="text-gray-500 hover:text-gray-700 p-2"
                                    >
                                        ❌
                                    </button>
                                </div>
                            </div>

                            <div className="p-6 overflow-y-auto custom-scroll" style={{maxHeight: 'calc(90vh - 140px)'}}>
                                {savedParts.length === 0 ? (
                                    <div className="text-center py-12">
                                        <div className="text-6xl mb-4">📭</div>
                                        <h3 className="text-xl font-semibold text-gray-600 mb-2">No hay partes guardados</h3>
                                        <p className="text-gray-500">Los partes que completes se mostrarán aquí</p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {savedParts.map((parte, index) => (
                                            <div key={parte.id || index} className="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div>
                                                        <h3 className="text-lg font-semibold text-blue-600">
                                                            {parte.nombreTrabajo || 'Sin nombre'}
                                                        </h3>
                                                        <p className="text-sm text-gray-500">
                                                            📅 {parte.fecha} | ⏰ {parte.totalHoras || 0}h | 👥 {parte.operarios?.length || 0} operarios
                                                        </p>
                                                        <p className="text-xs text-gray-400">
                                                            Guardado: {new Date(parte.timestamp).toLocaleString('es-ES')}
                                                        </p>
                                                    </div>
                                                    <button
                                                        onClick={() => {
                                                            if (confirm('¿Estás seguro de que quieres eliminar este parte?')) {
                                                                const updatedParts = savedParts.filter((_, i) => i !== index);
                                                                setSavedParts(updatedParts);
                                                                localStorage.setItem('partes_diarios', JSON.stringify(updatedParts));
                                                            }
                                                        }}
                                                        className="text-red-500 hover:text-red-700 p-1"
                                                    >
                                                        🗑️
                                                    </button>
                                                </div>

                                                <div className="grid md:grid-cols-2 gap-4 text-sm">
                                                    <div>
                                                        <h4 className="font-medium text-gray-700 mb-1">👥 Operarios:</h4>
                                                        <p className="text-gray-600 mb-3">
                                                            {parte.operarios?.map(op => `${op.nombre}: ${op.horas}h`).join(', ') || 'Sin operarios'}
                                                        </p>

                                                        <h4 className="font-medium text-gray-700 mb-1">🔧 Trabajos realizados:</h4>
                                                        <p className="text-gray-600 mb-3">
                                                            {parte.trabajosRealizados || 'Sin especificar'}
                                                        </p>

                                                        <h4 className="font-medium text-gray-700 mb-1">📦 Materiales:</h4>
                                                        <p className="text-gray-600 mb-3">
                                                            {parte.materialesUtilizados || 'Sin materiales'}
                                                        </p>
                                                    </div>

                                                    <div>
                                                        <h4 className="font-medium text-gray-700 mb-1">⚠️ Incidencias:</h4>
                                                        <p className="text-gray-600 mb-3">
                                                            {parte.incidencias || 'Sin incidencias'}
                                                        </p>

                                                        <h4 className="font-medium text-gray-700 mb-1">💭 Observaciones:</h4>
                                                        <p className="text-gray-600 mb-3">
                                                            {parte.observaciones || 'Sin observaciones'}
                                                        </p>

                                                        <h4 className="font-medium text-gray-700 mb-1">⏰ Tareas pendientes:</h4>
                                                        <p className="text-gray-600 mb-3">
                                                            {parte.tareasPendientes || 'Sin tareas pendientes'}
                                                        </p>
                                                    </div>
                                                </div>

                                                {(parte.imagenes?.length > 0 || parte.albaranes?.length > 0) && (
                                                    <div className="mt-3 pt-3 border-t">
                                                        <h4 className="font-medium text-gray-700 mb-2">📎 Archivos adjuntos:</h4>
                                                        <div className="flex gap-4 text-sm">
                                                            {parte.imagenes?.length > 0 && (
                                                                <span className="text-blue-600">
                                                                    📷 {parte.imagenes.length} imagen(es)
                                                                </span>
                                                            )}
                                                            {parte.albaranes?.length > 0 && (
                                                                <span className="text-green-600">
                                                                    📄 {parte.albaranes.length} documento(s)
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Modal "Acerca de"
            if (showAbout) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                            <div className="flex justify-between items-center p-6 border-b">
                                <h2 className="text-2xl font-bold">ℹ️ Acerca de</h2>
                                <button
                                    onClick={() => setShowAbout(false)}
                                    className="text-gray-500 hover:text-gray-700 p-2"
                                >
                                    ❌
                                </button>
                            </div>

                            <div className="p-6 space-y-6">
                                <div className="text-center">
                                    <div className="text-6xl mb-4">📋</div>
                                    <h3 className="text-2xl font-bold text-blue-600 mb-2">
                                        Asistente Personal - Parte Diario de Trabajo
                                    </h3>
                                    <p className="text-gray-600">
                                        Versión 2.0 - Aplicación web profesional para gestión de partes diarios
                                    </p>
                                </div>

                                <div className="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <h4 className="font-semibold text-gray-800 mb-3">🎯 Características principales:</h4>
                                        <ul className="space-y-2 text-sm text-gray-600">
                                            <li>• Formulario completo en 8 pasos</li>
                                            <li>• Dictado por voz integrado</li>
                                            <li>• Guardado local automático</li>
                                            <li>• Envío a Google Sheets</li>
                                            <li>• Exportación a CSV/Excel</li>
                                            <li>• Subida de imágenes y documentos</li>
                                            <li>• Interfaz responsive y moderna</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <h4 className="font-semibold text-gray-800 mb-3">🛠️ Tecnologías utilizadas:</h4>
                                        <ul className="space-y-2 text-sm text-gray-600">
                                            <li>• React 18 + Hooks</li>
                                            <li>• Tailwind CSS</li>
                                            <li>• Web Speech API</li>
                                            <li>• Google Apps Script</li>
                                            <li>• Local Storage</li>
                                            <li>• File API</li>
                                            <li>• Progressive Web App</li>
                                        </ul>
                                    </div>
                                </div>

                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <h4 className="font-semibold text-blue-800 mb-2">👨‍💻 Desarrollado por:</h4>
                                    <p className="text-blue-700">Michel Soler</p>
                                    <p className="text-sm text-blue-600 mt-1">
                                        Especialista en automatización y desarrollo de aplicaciones web para construcción y mantenimiento
                                    </p>
                                </div>

                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <h4 className="font-semibold text-gray-800 mb-2">📞 Soporte y contacto:</h4>
                                    <p className="text-sm text-gray-600">
                                        Para soporte técnico, consultas o personalizaciones,
                                        contacta a través de la configuración de la aplicación.
                                    </p>
                                </div>

                                <div className="text-center text-xs text-gray-500">
                                    © 2024 - Aplicación desarrollada con ❤️ para profesionales de la construcción
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showConfig) {
                return (
                    <div className="max-w-2xl mx-auto p-6 bg-white rounded-lg shadow-lg">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold">⚙️ Configuración</h1>
                            <button
                                onClick={() => setShowConfig(false)}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                ❌
                            </button>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <h3 className="text-lg font-semibold mb-4">📊 Google Apps Script</h3>
                                <p className="text-gray-600 mb-4">
                                    Conecta con tu Google Apps Script para enviar datos automáticamente a Google Sheets.
                                </p>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            URL del Google Apps Script
                                        </label>
                                        <input
                                            type="url"
                                            value={googleScriptUrl}
                                            onChange={(e) => saveGoogleScriptUrl(e.target.value)}
                                            placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"
                                            className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                        />
                                    </div>

                                    <div className="flex gap-3">
                                        <button
                                            onClick={testConnection}
                                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300"
                                            disabled={!googleScriptUrl.trim()}
                                        >
                                            🧪 Probar conexión
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Interface principal simplificada
            return (
                <div className="max-w-4xl mx-auto p-6 bg-white rounded-lg shadow-lg">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold">📋 Parte Diario de Trabajo</h1>
                        <div className="flex gap-2">
                            <button
                                onClick={() => setShowAbout(true)}
                                className="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
                            >
                                ℹ️ Acerca de
                            </button>
                            <button
                                onClick={() => setShowConfig(true)}
                                className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                            >
                                ⚙️ Config
                            </button>
                            <button
                                onClick={() => setShowSavedParts(true)}
                                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                            >
                                📋 Guardados ({savedParts.length})
                            </button>
                        </div>
                    </div>

                    {/* Indicador de progreso */}
                    <div className="mb-8">
                        <div className="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Paso {currentStep + 1} de 8</span>
                            <span>{Math.round(((currentStep + 1) / 8) * 100)}% completado</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                            <div
                                className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                style={{ width: `${((currentStep + 1) / 8) * 100}%` }}
                            ></div>
                        </div>
                    </div>

                    {/* Contenido del paso actual */}
                    <div className="mb-8">
                        {renderStep()}
                    </div>

                    {/* Botones de navegación */}
                    <div className="flex justify-between">
                        <button
                            onClick={() => setCurrentStep(Math.max(0, currentStep - 1))}
                            disabled={currentStep === 0}
                            className="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:bg-gray-300"
                        >
                            ⬅️ Anterior
                        </button>

                        {currentStep === 7 ? (
                            <button
                                onClick={saveAndSend}
                                className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
                            >
                                💾 Guardar y Enviar
                            </button>
                        ) : (
                            <button
                                onClick={() => setCurrentStep(Math.min(7, currentStep + 1))}
                                className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            >
                                Siguiente ➡️
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // Renderizar la aplicación
        ReactDOM.render(<ParteDiarioTrabajo />, document.getElementById('root'));
    </script>
</body>
</html>
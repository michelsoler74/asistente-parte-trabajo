<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Partes de Trabajo M√≥vil - Offline</title>
    <meta name="description" content="App m√≥vil offline para partes diarios de trabajo. Funciona sin internet, env√≠o directo por WhatsApp o Email">
    <meta name="keywords" content="parte diario, trabajo, dictado voz, construcci√≥n, mantenimiento, m√≥vil, offline">
    <meta name="author" content="Michel Soler">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìã</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React y Babel -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Mejoras para m√≥vil */
        @media (max-width: 640px) {
            /* √Årea t√°ctil mejorada */
            button {
                min-height: 44px;
                touch-action: manipulation;
            }

            /* Inputs optimizados para m√≥vil */
            input, textarea, select {
                font-size: 16px; /* Evita zoom en iOS */
                padding: 12px;
            }
        }

        /* Estilos para dictado por voz */
        .voice-active {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            border-color: #ef4444 !important;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Scrollbar personalizado */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const PartesDiarioApp = () => {
            const [currentStep, setCurrentStep] = useState(0);
            const [formData, setFormData] = useState({
                fecha: new Date().toISOString().split('T')[0],
                nombreTrabajo: '',
                operarios: [{ nombre: '', horas: '' }],
                trabajosRealizados: '',
                materialesUtilizados: '',
                incidencias: '',
                observaciones: '',
                tareasPendientes: '',
                imagenes: [],
                albaranes: [],
                resumenInteligente: ''
            });

            // Estados para configuraci√≥n m√≥vil
            const [userEmail, setUserEmail] = useState('');
            const [userWhatsApp, setUserWhatsApp] = useState('');
            const [sendMethod, setSendMethod] = useState('email'); // 'email' o 'whatsapp'

            // Estados de la UI
            const [showSettings, setShowSettings] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [partesHistory, setPartesHistory] = useState([]);
            const [saveStatus, setSaveStatus] = useState('');
            const [isListening, setIsListening] = useState(false);
            const [currentField, setCurrentField] = useState('');
            const [maxPartesLimit, setMaxPartesLimit] = useState(50);

            const recognitionRef = useRef(null);

            // Cargar configuraci√≥n al inicializar
            useEffect(() => {
                loadSavedData();
                loadHistoryData();

                const savedUserEmail = localStorage.getItem('user_email');
                if (savedUserEmail) setUserEmail(savedUserEmail);

                const savedUserWhatsApp = localStorage.getItem('user_whatsapp');
                if (savedUserWhatsApp) setUserWhatsApp(savedUserWhatsApp);

                const savedSendMethod = localStorage.getItem('send_method');
                if (savedSendMethod) setSendMethod(savedSendMethod);

                const savedLimit = localStorage.getItem('max_partes_limit');
                if (savedLimit) setMaxPartesLimit(parseInt(savedLimit));

                // Inicializar reconocimiento de voz
                console.log('üîç Verificando soporte de reconocimiento de voz...');
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    console.log('‚úÖ Reconocimiento de voz soportado');
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;
                    recognitionRef.current.lang = 'es-ES';
                    console.log('‚úÖ Configuraci√≥n de voz completada');

                    recognitionRef.current.onresult = (event) => {
                        let interimTranscript = '';
                        let finalTranscript = '';

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            } else {
                                interimTranscript += transcript;
                            }
                        }

                        // Usar cualquier transcripci√≥n disponible
                        const textToAdd = finalTranscript || interimTranscript;
                        if (textToAdd && textToAdd.trim()) {
                            console.log('üé§ Transcripci√≥n recibida:', textToAdd);
                            handleVoiceInput(currentField, textToAdd.trim());
                        }
                    };

                    recognitionRef.current.onstart = () => {
                        console.log('üé§ Reconocimiento iniciado correctamente');
                    };

                    recognitionRef.current.onend = () => {
                        console.log('üî¥ Reconocimiento terminado');
                        setIsListening(false);
                        setCurrentField('');
                    };

                    recognitionRef.current.onerror = (event) => {
                        console.error('‚ùå ERROR EN RECONOCIMIENTO DE VOZ:', event.error);
                        console.error('‚ùå Detalles del error:', event);
                        setIsListening(false);
                        setCurrentField('');

                        // Mostrar error espec√≠fico al usuario
                        let errorMessage = 'Error en reconocimiento de voz: ';
                        switch(event.error) {
                            case 'not-allowed':
                                errorMessage += 'Permisos de micr√≥fono denegados. Ve a configuraci√≥n del navegador.';
                                break;
                            case 'no-speech':
                                errorMessage += 'No se detect√≥ habla. Intenta hablar m√°s cerca del micr√≥fono.';
                                break;
                            case 'audio-capture':
                                errorMessage += 'No se pudo acceder al micr√≥fono.';
                                break;
                            case 'network':
                                errorMessage += 'Error de red. Verifica tu conexi√≥n a internet.';
                                break;
                            default:
                                errorMessage += event.error;
                        }
                        alert(errorMessage);
                    };
                } else {
                    console.error('‚ùå Reconocimiento de voz NO soportado en este navegador');
                    alert('‚ùå Tu navegador no soporta reconocimiento de voz\n\n‚úÖ Navegadores compatibles:\n‚Ä¢ Chrome\n‚Ä¢ Edge\n‚Ä¢ Safari (iOS)\n\n‚ùå No funciona en:\n‚Ä¢ Firefox\n‚Ä¢ Modo inc√≥gnito (algunas versiones)');
                }

                return () => {
                    if (recognitionRef.current) {
                        recognitionRef.current.stop();
                    }
                };
            }, []);

            // Funci√≥n para guardar configuraci√≥n m√≥vil
            const saveMobileConfig = (email, whatsapp, method) => {
                setUserEmail(email);
                setUserWhatsApp(whatsapp);
                setSendMethod(method);
                localStorage.setItem('user_email', email);
                localStorage.setItem('user_whatsapp', whatsapp);
                localStorage.setItem('send_method', method);
            };

            // Funci√≥n para enviar por Email
            const sendByEmail = async () => {
                if (!userEmail.trim()) {
                    alert('‚ö†Ô∏è Configura tu email primero en la secci√≥n de configuraci√≥n');
                    return false;
                }

                try {
                    // Primero generar el PDF
                    await exportToPDF();

                    // Preparar resumen del parte
                    const totalHoras = formData.operarios?.reduce((sum, op) => sum + (parseFloat(op.horas) || 0), 0) || 0;
                    const fechaFormateada = new Date(formData.fecha).toLocaleDateString('es-ES');

                    const resumenEmail = `
üìã PARTE DIARIO DE TRABAJO
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üèóÔ∏è Proyecto: ${formData.nombreTrabajo}
üìÖ Fecha: ${fechaFormateada}
‚è∞ Total Horas: ${totalHoras}h
üë∑ Operarios: ${formData.operarios?.length || 0}

üìù TRABAJOS REALIZADOS:
${formData.trabajosRealizados || 'Sin especificar'}

üì¶ MATERIALES:
${formData.materialesUtilizados || 'Sin especificar'}

${formData.incidencias ? `‚ö†Ô∏è INCIDENCIAS:\n${formData.incidencias}\n` : ''}
${formData.observaciones ? `üí° OBSERVACIONES:\n${formData.observaciones}\n` : ''}
${formData.tareasPendientes ? `üìã TAREAS PENDIENTES:\n${formData.tareasPendientes}\n` : ''}

üìä ARCHIVOS ADJUNTOS:
üì∑ Im√°genes: ${formData.imagenes?.length || 0}
üìÑ Documentos: ${formData.albaranes?.length || 0}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üì± Enviado desde App M√≥vil de Partes
`;

                    // Crear enlace mailto
                    const subject = `Parte Diario - ${formData.nombreTrabajo} - ${fechaFormateada}`;
                    const body = encodeURIComponent(resumenEmail);
                    const mailtoLink = `mailto:${userEmail}?subject=${encodeURIComponent(subject)}&body=${body}`;

                    // Abrir cliente de email
                    window.open(mailtoLink, '_self');

                    alert('üìß Email preparado\n\n‚úÖ Se ha abierto tu cliente de email\nüìÑ No olvides adjuntar el archivo PDF descargado\nüíæ El parte se ha guardado localmente');

                    // Guardar en historial local
                    saveToHistory();

                    // Crear nuevo parte
                    createNewParte();

                    return true;

                } catch (error) {
                    console.error('Error enviando email:', error);
                    alert('‚ùå Error preparando email\n\n' + error.message + '\n\nPero el parte se ha guardado localmente.');
                    return false;
                }
            };

            // Funci√≥n para enviar por WhatsApp
            const sendByWhatsApp = async () => {
                if (!userWhatsApp.trim()) {
                    alert('‚ö†Ô∏è Configura tu WhatsApp primero en la secci√≥n de configuraci√≥n');
                    return false;
                }

                try {
                    // Primero generar el PDF
                    await exportToPDF();

                    // Preparar resumen del parte para WhatsApp (m√°s conciso)
                    const totalHoras = formData.operarios?.reduce((sum, op) => sum + (parseFloat(op.horas) || 0), 0) || 0;
                    const fechaFormateada = new Date(formData.fecha).toLocaleDateString('es-ES');

                    const resumenWhatsApp = `üèóÔ∏è *PARTE DIARIO*

üìã *${formData.nombreTrabajo}*
üìÖ ${fechaFormateada} | ‚è∞ ${totalHoras}h | üë∑ ${formData.operarios?.length || 0} operarios

üîß *Trabajos:*
${formData.trabajosRealizados || 'Sin especificar'}

üì¶ *Materiales:*
${formData.materialesUtilizados || 'Sin especificar'}

${formData.incidencias ? `‚ö†Ô∏è *Incidencias:*\n${formData.incidencias}\n` : ''}
${formData.observaciones ? `üí° *Observaciones:*\n${formData.observaciones}\n` : ''}
${formData.tareasPendientes ? `üìã *Pendientes:*\n${formData.tareasPendientes}\n` : ''}

üìä Adjuntos: ${formData.imagenes?.length || 0} fotos, ${formData.albaranes?.length || 0} docs

üìÑ *PDF descargado autom√°ticamente para adjuntar*

üì± _Enviado desde App M√≥vil_`;

                    // Limpiar n√∫mero de WhatsApp (quitar espacios, guiones, etc.)
                    const cleanNumber = userWhatsApp.replace(/[^\d+]/g, '');

                    // Crear enlace de WhatsApp
                    const whatsappLink = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(resumenWhatsApp)}`;

                    // Abrir WhatsApp
                    window.open(whatsappLink, '_blank');

                    alert('üì± WhatsApp abierto con env√≠o completo\n\n‚úÖ Se ha preparado el mensaje\nüìÑ El PDF se ha descargado autom√°ticamente\nüìé Adjunta tambi√©n el archivo PDF descargado\nüíæ El parte se ha guardado localmente');

                    // Guardar en historial local
                    saveToHistory();

                    // Crear nuevo parte
                    createNewParte();

                    return true;

                } catch (error) {
                    console.error('Error enviando WhatsApp:', error);
                    alert('‚ùå Error preparando WhatsApp\n\n' + error.message + '\n\nPero el parte se ha guardado localmente.');
                    return false;
                }
            };

            // Funci√≥n unificada de env√≠o
            const sendParte = async () => {
                if (sendMethod === 'email') {
                    return await sendByEmail();
                } else if (sendMethod === 'whatsapp') {
                    return await sendByWhatsApp();
                } else {
                    alert('‚ö†Ô∏è Selecciona un m√©todo de env√≠o en la configuraci√≥n');
                    return false;
                }
            };

            // Funci√≥n para convertir archivos a base64
            const convertToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            };

            // Funciones de guardado y carga
            const loadSavedData = () => {
                try {
                    const saved = localStorage.getItem('parte_diario_current');
                    if (saved) {
                        const data = JSON.parse(saved);
                        setFormData(data);
                        setSaveStatus('loaded');
                    }

                    let currentId = localStorage.getItem('parte_diario_current_id');
                    if (!currentId) {
                        const newId = 'parte_' + Date.now();
                        localStorage.setItem('parte_diario_current_id', newId);
                    }
                } catch (error) {
                    console.error('Error cargando datos:', error);
                    setSaveStatus('error');
                }
            };

            const loadHistoryData = () => {
                try {
                    const history = localStorage.getItem('partes_diarios_history');
                    if (history) {
                        setPartesHistory(JSON.parse(history));
                    }
                } catch (error) {
                    console.error('Error cargando historial:', error);
                }
            };

            // Auto-save cada 2 segundos
            useEffect(() => {
                const timeoutId = setTimeout(() => {
                    try {
                        setSaveStatus('saving');
                        localStorage.setItem('parte_diario_current', JSON.stringify(formData));
                        setSaveStatus('saved');
                    } catch (error) {
                        console.error('Error guardando:', error);
                        setSaveStatus('error');
                    }
                }, 2000);

                return () => clearTimeout(timeoutId);
            }, [formData]);

            // Funciones de historial
            const saveToHistory = () => {
                try {
                    const currentId = localStorage.getItem('parte_diario_current_id') || 'parte_' + Date.now();
                    const parteToSave = {
                        id: currentId,
                        ...formData,
                        fechaCreacion: new Date().toISOString(),
                        ultimaModificacion: new Date().toISOString(),
                        completado: true
                    };

                    const updatedHistory = [...partesHistory];
                    const existingIndex = updatedHistory.findIndex(p => p.id === currentId);

                    if (existingIndex >= 0) {
                        updatedHistory[existingIndex] = parteToSave;
                    } else {
                        updatedHistory.unshift(parteToSave);
                    }

                    // Mantener solo los √∫ltimos maxPartesLimit
                    const limitedHistory = updatedHistory.slice(0, maxPartesLimit);

                    setPartesHistory(limitedHistory);
                    localStorage.setItem('partes_diarios_history', JSON.stringify(limitedHistory));

                    createNewParte();
                    return true;
                } catch (error) {
                    console.error('Error guardando en historial:', error);
                    return false;
                }
            };

            const createNewParte = () => {
                const newId = 'parte_' + Date.now();
                localStorage.setItem('parte_diario_current_id', newId);

                const newFormData = {
                    fecha: new Date().toISOString().split('T')[0],
                    nombreTrabajo: '',
                    operarios: [{ nombre: '', horas: '' }],
                    trabajosRealizados: '',
                    materialesUtilizados: '',
                    incidencias: '',
                    observaciones: '',
                    tareasPendientes: '',
                    imagenes: [],
                    albaranes: [],
                    resumenInteligente: ''
                };

                setFormData(newFormData);
                setCurrentStep(0);
                localStorage.removeItem('parte_diario_current');
            };

            // Funciones de UI
            const handleInputChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            const addOperario = () => {
                setFormData(prev => ({
                    ...prev,
                    operarios: [...prev.operarios, { nombre: '', horas: '' }]
                }));
            };

            const updateOperario = (index, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    operarios: prev.operarios.map((op, i) =>
                        i === index ? { ...op, [field]: value } : op
                    )
                }));
            };

            const removeOperario = (index) => {
                if (formData.operarios.length > 1) {
                    setFormData(prev => ({
                        ...prev,
                        operarios: prev.operarios.filter((_, i) => i !== index)
                    }));
                }
            };

            // Funciones de voz
            const startVoiceRecognition = (fieldName) => {
                if (!recognitionRef.current) {
                    alert('‚ùå Tu navegador no soporta reconocimiento de voz\n\nNecesitas usar Chrome, Edge o Safari');
                    return;
                }

                console.log('üé§ Iniciando reconocimiento para campo:', fieldName);

                // Detener cualquier reconocimiento previo
                try {
                    recognitionRef.current.stop();
                } catch (e) {
                    // Ignorar error si no estaba corriendo
                }

                // Configurar el campo actual antes de iniciar
                setCurrentField(fieldName);
                setIsListening(true);

                // Esperar un momento antes de iniciar el nuevo reconocimiento
                setTimeout(() => {
                    try {
                        recognitionRef.current.start();
                        console.log('‚úÖ Reconocimiento iniciado correctamente para:', fieldName);
                    } catch (error) {
                        console.error('‚ùå Error al iniciar reconocimiento:', error);
                        setIsListening(false);
                        setCurrentField('');
                        alert('‚ùå Error al iniciar el reconocimiento de voz\n\nIntenta de nuevo o verifica los permisos de micr√≥fono');
                    }
                }, 100);
            };

            const stopVoiceRecognition = () => {
                if (recognitionRef.current) {
                    recognitionRef.current.stop();
                    setIsListening(false);
                    setCurrentField('');
                }
            };

            const handleVoiceInput = (fieldName, transcript) => {
                console.log('üé§ Voz recibida:', { fieldName, transcript });

                if (!transcript || !transcript.trim()) {
                    console.log('‚ùå Transcripci√≥n vac√≠a, ignorando');
                    return;
                }

                try {
                    // Manejar campos especiales de operarios
                    if (fieldName.startsWith('operario_')) {
                        const parts = fieldName.split('_');
                        const operarioIndex = parseInt(parts[1]);
                        const operarioField = parts[2];

                        console.log('üë∑ Actualizando operario:', { operarioIndex, operarioField });

                        if (operarioField === 'nombre' && formData.operarios[operarioIndex]) {
                            const currentValue = formData.operarios[operarioIndex].nombre || '';
                            const newValue = currentValue + (currentValue ? ' ' : '') + transcript;
                            console.log('üìù Nombre operario:', { currentValue, newValue });
                            updateOperario(operarioIndex, 'nombre', newValue);
                        }
                    } else {
                        // Manejar campos normales
                        const currentValue = formData[fieldName] || '';
                        const newValue = currentValue + (currentValue ? ' ' : '') + transcript;
                        console.log('üìù Actualizando campo normal:', { fieldName, currentValue, newValue });
                        handleInputChange(fieldName, newValue);
                    }
                } catch (error) {
                    console.error('‚ùå Error en handleVoiceInput:', error);
                }
            };

            // Componente de bot√≥n de voz
            const VoiceButton = ({ fieldName }) => {
                const isActiveField = isListening && currentField === fieldName;

                return (
                    <button
                        type="button"
                        onClick={() => isActiveField ? stopVoiceRecognition() : startVoiceRecognition(fieldName)}
                        className={`ml-2 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${
                            isActiveField
                                ? 'bg-red-500 text-white shadow-lg'
                                : 'bg-blue-500 text-white hover:bg-blue-600'
                        }`}
                        title={isActiveField ? 'Parar dictado' : 'Activar dictado por voz'}
                    >
                        {isActiveField ? 'üî¥ Parar' : 'üé§ Dictar'}
                    </button>
                );
            };

            // Validaci√≥n
            const canFinishParte = () => {
                const hasWorkName = formData.nombreTrabajo && formData.nombreTrabajo.trim().length > 0;
                const hasValidOperario = formData.operarios.some(op =>
                    op.nombre && op.nombre.trim().length > 0 &&
                    op.horas && parseFloat(op.horas) > 0
                );
                return hasWorkName && hasValidOperario;
            };

            // Navegaci√≥n entre pasos
            const nextStep = () => {
                if (currentStep < steps.length - 1) {
                    setCurrentStep(currentStep + 1);
                }
            };

            const prevStep = () => {
                if (currentStep > 0) {
                    setCurrentStep(currentStep - 1);
                }
            };

            // Exportar a PDF
            const exportToPDF = () => {
                const totalHoras = formData.operarios.reduce((sum, op) => sum + (parseFloat(op.horas) || 0), 0);
                const fecha = new Date(formData.fecha);
                const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Parte Diario de Trabajo - ${formData.nombreTrabajo}</title>
    <style>
        @media print {
            body { margin: 0; }
            .page-break { page-break-after: always; }
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            line-height: 1.6;
            color: #333;
            background: white;
        }
        .header {
            text-align: center;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .company-logo {
            font-size: 28px;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 5px;
        }
        .document-title {
            font-size: 24px;
            font-weight: bold;
            color: #1e40af;
            margin: 10px 0;
        }
        .work-info {
            background: #f8fafc;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin: 20px 0;
        }
        .section {
            margin: 25px 0;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #1e40af;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        .personnel-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .personnel-table th,
        .personnel-table td {
            border: 1px solid #cbd5e1;
            padding: 12px;
            text-align: left;
        }
        .personnel-table th {
            background: #f1f5f9;
            font-weight: bold;
            color: #1e40af;
        }
        .personnel-table .total-row {
            background: #e0f2fe;
            font-weight: bold;
        }
        .content-box {
            background: #fafafa;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .alert-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 10px 0;
        }
        .warning-box {
            background: #fffbeb;
            border: 1px solid #fed7aa;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 10px 0;
        }
        .pending-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-left: 4px solid #0284c7;
            padding: 15px;
            margin: 10px 0;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
        }
        .stat-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
            text-align: center;
            font-size: 12px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="company-logo">üèóÔ∏è CONSTRUCCIONES</div>
        <div class="document-title">PARTE DIARIO DE TRABAJO</div>
        <div style="font-size: 14px; color: #64748b;">Documento oficial - ${new Date().toLocaleDateString('es-ES')}</div>
    </div>

    <div class="work-info">
        <h2 style="margin: 0 0 10px 0; color: #1e40af;">üìã INFORMACI√ìN DEL TRABAJO</h2>
        <p style="margin: 5px 0;"><strong>Proyecto:</strong> ${formData.nombreTrabajo}</p>
        <p style="margin: 5px 0;"><strong>Fecha:</strong> ${fechaFormateada}</p>
        <p style="margin: 5px 0;"><strong>Generado:</strong> ${new Date().toLocaleString('es-ES')}</p>
    </div>

    <div class="summary-stats">
        <div class="stat-card">
            <div class="stat-number">${totalHoras}h</div>
            <div class="stat-label">HORAS TOTALES</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${formData.operarios.length}</div>
            <div class="stat-label">OPERARIOS</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${formData.imagenes.length}</div>
            <div class="stat-label">IM√ÅGENES</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${formData.incidencias ? 'S√ç' : 'NO'}</div>
            <div class="stat-label">INCIDENCIAS</div>
        </div>
    </div>

    <div class="section">
        <h3 class="section-title">üë∑‚Äç‚ôÇÔ∏è PERSONAL Y HORAS TRABAJADAS</h3>
        <table class="personnel-table">
            <thead>
                <tr>
                    <th>Operario</th>
                    <th>Horas Trabajadas</th>
                    <th>Observaciones</th>
                </tr>
            </thead>
            <tbody>
                ${formData.operarios.map(op => `
                <tr>
                    <td>${op.nombre}</td>
                    <td>${op.horas}h</td>
                    <td>-</td>
                </tr>
                `).join('')}
                <tr class="total-row">
                    <td><strong>TOTAL HORAS</strong></td>
                    <td><strong>${totalHoras}h</strong></td>
                    <td><strong>${(totalHoras / formData.operarios.length).toFixed(1)}h promedio</strong></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h3 class="section-title">üîß TRABAJOS REALIZADOS</h3>
        <div class="content-box">
            <p>${formData.trabajosRealizados}</p>
        </div>
    </div>

    <div class="section">
        <h3 class="section-title">üì¶ MATERIALES UTILIZADOS</h3>
        <div class="content-box">
            <p>‚Ä¢ ${formData.materialesUtilizados}</p>
        </div>
    </div>

    ${formData.incidencias ? `
    <div class="section">
        <h3 class="section-title">‚ö†Ô∏è INCIDENCIAS</h3>
        <div class="alert-box">
            <p>${formData.incidencias}</p>
        </div>
    </div>
    ` : ''}

    ${formData.observaciones ? `
    <div class="section">
        <h3 class="section-title">üí° OBSERVACIONES</h3>
        <div class="warning-box">
            <p>${formData.observaciones}</p>
        </div>
    </div>
    ` : ''}

    ${formData.tareasPendientes ? `
    <div class="section">
        <h3 class="section-title">üìã TAREAS PENDIENTES</h3>
        <div class="pending-box">
            <p>‚Ä¢ ${formData.tareasPendientes}</p>
        </div>
    </div>
    ` : ''}

    ${(formData.imagenes && formData.imagenes.length > 0) || (formData.albaranes && formData.albaranes.length > 0) ? `
    <div class="section page-break">
        <h3 class="section-title">üìé ARCHIVOS ADJUNTOS</h3>

        ${formData.imagenes && formData.imagenes.length > 0 ? `
        <div style="margin: 20px 0;">
            <h4 style="color: #059669; margin: 20px 0 15px 0;">üì∑ IM√ÅGENES DEL TRABAJO (${formData.imagenes.length})</h4>
            ${formData.imagenes.map((imagen, index) => `
                <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; background: white; margin: 15px 0; text-align: center;">
                    <img src="${imagen.data || imagen.url}" alt="${imagen.name}" style="max-width: 100%; width: auto; height: auto; border-radius: 4px; margin: 0 auto 10px auto; display: block;">
                    <p style="margin: 0; font-size: 12px; color: #64748b; font-weight: bold;">üì∑ Imagen ${index + 1}</p>
                    <p style="margin: 5px 0 0 0; font-size: 11px; color: #64748b;">${imagen.name}</p>
                    <p style="margin: 2px 0 0 0; font-size: 10px; color: #94a3b8;">${imagen.size ? (imagen.size / 1024 / 1024).toFixed(2) + ' MB' : 'Tama√±o no disponible'}</p>
                </div>
            `).join('')}
        </div>
        ` : ''}

        ${formData.albaranes && formData.albaranes.length > 0 ? `
        <div style="margin-top: 30px;">
            <h4 style="color: #dc2626; margin: 20px 0 15px 0;">üìÑ ALBARANES Y DOCUMENTOS (${formData.albaranes.length})</h4>
            ${formData.albaranes.map((albaran, index) => {
                const isImage = (albaran.type && albaran.type.startsWith('image/')) ||
                              (albaran.name && /\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(albaran.name));

                if (isImage) {
                    return `
                        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 15px 0; background: white; text-align: center;">
                            <img src="${albaran.data || albaran.url}" alt="${albaran.name}" style="max-width: 100%; width: auto; height: auto; border-radius: 4px; margin: 0 auto 10px auto; display: block;">
                            <p style="margin: 0; font-size: 12px; color: #dc2626; font-weight: bold;">üìÑ Documento ${index + 1}</p>
                            <p style="margin: 5px 0 0 0; font-size: 11px; color: #64748b;">${albaran.name}</p>
                            <p style="margin: 2px 0 0 0; font-size: 10px; color: #94a3b8;">${albaran.size ? (albaran.size / 1024 / 1024).toFixed(2) + ' MB' : 'Tama√±o no disponible'}</p>
                        </div>
                    `;
                } else {
                    return `
                        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 15px 0; background: #fafafa; border-left: 4px solid #dc2626;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 48px;">üìÑ</div>
                                <div>
                                    <p style="margin: 0; font-size: 14px; color: #dc2626; font-weight: bold;">üìÑ Documento ${index + 1}</p>
                                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #374151; font-weight: bold;">${albaran.name}</p>
                                    <p style="margin: 2px 0 0 0; font-size: 11px; color: #64748b;">Tama√±o: ${albaran.size ? (albaran.size / 1024 / 1024).toFixed(2) + ' MB' : 'No disponible'}</p>
                                    <p style="margin: 2px 0 0 0; font-size: 11px; color: #64748b;">Tipo: ${albaran.category || albaran.type || 'Documento'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('')}
        </div>
        ` : ''}
    </div>
    ` : ''}

    <div class="footer">
        <p>Documento generado autom√°ticamente por el Sistema de Gesti√≥n de Partes Diarios M√≥vil</p>
        <p>Este documento es v√°lido sin firma seg√∫n la normativa interna de la empresa</p>
        <p>Generado el ${new Date().toLocaleString('es-ES')}</p>
    </div>
</body>
</html>`;

                // Crear y descargar archivo
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Parte_Diario_${formData.fecha}_${formData.nombreTrabajo?.replace(/[^a-zA-Z0-9]/g, '_') || 'sin_nombre'}.html`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                alert('üìÑ PDF Profesional generado como HTML\n\n‚úÖ Para convertir a PDF:\n1. Abre el archivo HTML descargado\n2. Ctrl+P (Imprimir)\n3. Selecciona "Guardar como PDF"\n4. ¬°Listo! Tendr√°s un PDF profesional');
            };

            // Definir pasos
            const steps = [
                'Informaci√≥n b√°sica',
                'Personal y horas',
                'Trabajos realizados',
                'Materiales utilizados',
                'Incidencias y observaciones',
                'Tareas pendientes',
                'Im√°genes',
                'Albaranes',
                'Resumen final'
            ];

            // Indicador de estado de guardado
            const SaveStatusIndicator = () => {
                const getStatusInfo = () => {
                    switch (saveStatus) {
                        case 'saving':
                            return { text: 'Guardando...', color: 'text-yellow-600', icon: '‚è≥' };
                        case 'saved':
                            return { text: 'Guardado', color: 'text-green-600', icon: '‚úÖ' };
                        case 'error':
                            return { text: 'Error al guardar', color: 'text-red-600', icon: '‚ùå' };
                        default:
                            return { text: 'Sin guardar', color: 'text-gray-600', icon: '‚ö™' };
                    }
                };

                const status = getStatusInfo();
                return (
                    <div className={`flex items-center gap-1 text-sm ${status.color}`}>
                        <span>{status.icon}</span>
                        <span>{status.text}</span>
                    </div>
                );
            };

            // Renderizar paso actual
            const renderStep = () => {
                switch (currentStep) {
                    case 0: // Informaci√≥n b√°sica
                        return (
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-2">¬øCu√°l es el nombre del trabajo o proyecto?</label>
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={formData.nombreTrabajo}
                                            onChange={(e) => handleInputChange('nombreTrabajo', e.target.value)}
                                            placeholder="Ej: Construcci√≥n casa unifamiliar, Reforma ba√±o..."
                                            className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        />
                                        <VoiceButton fieldName="nombreTrabajo" />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-2">Fecha del trabajo</label>
                                    <input
                                        type="date"
                                        value={formData.fecha}
                                        onChange={(e) => handleInputChange('fecha', e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>
                        );

                    case 1: // Personal y horas
                        return (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-lg font-semibold">üë∑‚Äç‚ôÇÔ∏è Personal trabajando</h3>
                                    <button
                                        onClick={addOperario}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    >
                                        ‚ûï A√±adir operario
                                    </button>
                                </div>

                                {formData.operarios.map((operario, index) => (
                                    <div key={index} className="p-4 bg-gray-50 rounded-lg">
                                        <div className="flex justify-between items-center mb-3">
                                            <span className="font-medium">Operario {index + 1}</span>
                                            {formData.operarios.length > 1 && (
                                                <button
                                                    onClick={() => removeOperario(index)}
                                                    className="text-red-600 hover:text-red-800"
                                                >
                                                    üóëÔ∏è Eliminar
                                                </button>
                                            )}
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Nombre</label>
                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        value={operario.nombre}
                                                        onChange={(e) => updateOperario(index, 'nombre', e.target.value)}
                                                        placeholder="Nombre del operario"
                                                        className="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                    <VoiceButton fieldName={`operario_${index}_nombre`} />
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium mb-1">Horas trabajadas</label>
                                                <input
                                                    type="number"
                                                    step="0.5"
                                                    min="0"
                                                    max="24"
                                                    value={operario.horas}
                                                    onChange={(e) => updateOperario(index, 'horas', e.target.value)}
                                                    placeholder="8"
                                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                ))}

                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <h4 className="font-semibold text-blue-800 mb-2">üìä Resumen de horas</h4>
                                    <div className="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span className="font-medium">Total horas:</span> {formData.operarios.reduce((sum, op) => sum + (parseFloat(op.horas) || 0), 0)}h
                                        </div>
                                        <div>
                                            <span className="font-medium">Operarios:</span> {formData.operarios.length}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );

                    case 2: // Trabajos realizados
                        return (
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-2">Describe detalladamente los trabajos realizados hoy</label>
                                    <div className="flex gap-2">
                                        <textarea
                                            value={formData.trabajosRealizados}
                                            onChange={(e) => handleInputChange('trabajosRealizados', e.target.value)}
                                            placeholder="Describe qu√© trabajos espec√≠ficos se han realizado hoy..."
                                            rows="6"
                                            className={`flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                                isListening && currentField === 'trabajosRealizados' ? 'voice-active' : ''
                                            }`}
                                        />
                                        <VoiceButton fieldName="trabajosRealizados" />
                                    </div>

                                    {isListening && currentField === 'trabajosRealizados' && (
                                        <div className="mt-2 p-2 bg-red-50 border border-red-200 rounded-lg">
                                            <p className="text-sm text-red-700">üé§ Dictando... Habla claramente y haz pausas entre ideas</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );

                    case 3: // Materiales utilizados
                        return (
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-2">¬øQu√© materiales y herramientas se han utilizado?</label>
                                    <div className="flex gap-2">
                                        <textarea
                                            value={formData.materialesUtilizados}
                                            onChange={(e) => handleInputChange('materialesUtilizados', e.target.value)}
                                            placeholder="Lista los materiales, herramientas y equipos utilizados..."
                                            rows="5"
                                            className={`flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                                isListening && currentField === 'materialesUtilizados' ? 'voice-active' : ''
                                            }`}
                                        />
                                        <VoiceButton fieldName="materialesUtilizados" />
                                    </div>
                                </div>
                            </div>
                        );

                    case 4: // Incidencias y observaciones
                        return (
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-2">üö® ¬øHa habido alguna incidencia o problema?</label>
                                    <div className="flex gap-2">
                                        <textarea
                                            value={formData.incidencias}
                                            onChange={(e) => handleInputChange('incidencias', e.target.value)}
                                            placeholder="Describe cualquier problema, incidencia o situaci√≥n especial..."
                                            rows="4"
                                            className={`flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                                isListening && currentField === 'incidencias' ? 'voice-active' : ''
                                            }`}
                                        />
                                        <VoiceButton fieldName="incidencias" />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-2">üí° Observaciones adicionales</label>
                                    <div className="flex gap-2">
                                        <textarea
                                            value={formData.observaciones}
                                            onChange={(e) => handleInputChange('observaciones', e.target.value)}
                                            placeholder="Cualquier observaci√≥n, comentario o nota adicional..."
                                            rows="4"
                                            className={`flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                                isListening && currentField === 'observaciones' ? 'voice-active' : ''
                                            }`}
                                        />
                                        <VoiceButton fieldName="observaciones" />
                                    </div>
                                </div>
                            </div>
                        );

                    case 5: // Tareas pendientes
                        return (
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-2">üìã ¬øQu√© queda pendiente para ma√±ana o pr√≥ximos d√≠as?</label>
                                    <div className="flex gap-2">
                                        <textarea
                                            value={formData.tareasPendientes}
                                            onChange={(e) => handleInputChange('tareasPendientes', e.target.value)}
                                            placeholder="Lista las tareas que quedan pendientes, materiales que faltan, etc..."
                                            rows="5"
                                            className={`flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                                isListening && currentField === 'tareasPendientes' ? 'voice-active' : ''
                                            }`}
                                        />
                                        <VoiceButton fieldName="tareasPendientes" />
                                    </div>
                                </div>
                            </div>
                        );

                    case 6: // Im√°genes
                        return (
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-3">üì∑ Fotos del trabajo realizado</label>

                                    {/* Botones de opciones */}
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                                        {/* Tomar foto con c√°mara */}
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Tomar foto nueva:</label>
                                            <input
                                                type="file"
                                                multiple
                                                accept="image/*"
                                                capture="environment"
                                                onChange={async (e) => {
                                                    const files = Array.from(e.target.files);
                                                    const processFiles = async () => {
                                                        const processedImages = [];

                                                        for (const file of files) {
                                                            try {
                                                                const base64 = await convertToBase64(file);
                                                                processedImages.push({
                                                                    name: file.name,
                                                                    size: file.size,
                                                                    type: file.type,
                                                                    data: base64,
                                                                    timestamp: new Date().toISOString()
                                                                });
                                                            } catch (error) {
                                                                console.error('Error procesando imagen:', file.name, error);
                                                            }
                                                        }

                                                        const allImages = [...(formData.imagenes || []), ...processedImages];
                                                        handleInputChange('imagenes', allImages);
                                                    };

                                                    processFiles();
                                                    e.target.value = '';
                                                }}
                                                className="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-blue-50"
                                            />
                                        </div>

                                        {/* Seleccionar desde galer√≠a */}
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Seleccionar desde galer√≠a:</label>
                                            <input
                                                type="file"
                                                multiple
                                                accept="image/*"
                                                onChange={async (e) => {
                                                    const files = Array.from(e.target.files);
                                                    const processFiles = async () => {
                                                        const processedImages = [];

                                                        for (const file of files) {
                                                            try {
                                                                const base64 = await convertToBase64(file);
                                                                processedImages.push({
                                                                    name: file.name,
                                                                    size: file.size,
                                                                    type: file.type,
                                                                    data: base64,
                                                                    timestamp: new Date().toISOString()
                                                                });
                                                            } catch (error) {
                                                                console.error('Error procesando imagen:', file.name, error);
                                                            }
                                                        }

                                                        const allImages = [...(formData.imagenes || []), ...processedImages];
                                                        handleInputChange('imagenes', allImages);
                                                    };

                                                    processFiles();
                                                    e.target.value = '';
                                                }}
                                                className="w-full p-3 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 bg-green-50"
                                            />
                                        </div>
                                    </div>

                                    {formData.imagenes && formData.imagenes.length > 0 && (
                                        <div className="mt-3">
                                            <p className="text-sm text-gray-600 mb-3">
                                                {formData.imagenes.length} imagen(es) adjuntada(s):
                                            </p>
                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                                {formData.imagenes.map((image, index) => (
                                                    <div key={index} className="relative border rounded-lg p-2 bg-gray-50">
                                                        <img
                                                            src={image.data}
                                                            alt={image.name}
                                                            className="w-full h-24 object-cover rounded mb-2"
                                                            onError={(e) => {
                                                                e.target.style.display = 'none';
                                                                e.target.nextSibling.style.display = 'block';
                                                            }}
                                                        />
                                                        <div className="hidden text-center text-gray-500 text-xs">
                                                            Error cargando imagen
                                                        </div>
                                                        <p className="text-xs text-gray-600 truncate">
                                                            {image.name}
                                                        </p>
                                                        <p className="text-xs text-gray-500">
                                                            {(image.size / 1024).toFixed(0)} KB
                                                        </p>
                                                        <button
                                                            onClick={() => {
                                                                const newImages = formData.imagenes.filter((_, i) => i !== index);
                                                                handleInputChange('imagenes', newImages);
                                                            }}
                                                            className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
                                                        >
                                                            ‚úï
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );

                    case 7: // Albaranes
                        return (
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-3">üìÑ Albaranes y documentos</label>

                                    {/* Botones de opciones para albaranes */}
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                                        {/* Capturar nuevo documento */}
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Capturar documento nuevo:</label>
                                            <input
                                                type="file"
                                                multiple
                                                accept="image/*"
                                                capture="environment"
                                                onChange={(e) => {
                                                    const files = Array.from(e.target.files);
                                                    files.forEach(file => {
                                                        const reader = new FileReader();
                                                        reader.onload = (event) => {
                                                            const newAlbaran = {
                                                                name: file.name,
                                                                url: event.target.result,
                                                                data: event.target.result,
                                                                size: file.size,
                                                                type: file.type,
                                                                category: 'albaran'
                                                            };
                                                            const currentAlbaranes = formData.albaranes || [];
                                                            const newAlbaranes = [...currentAlbaranes, newAlbaran];
                                                            setFormData({...formData, albaranes: newAlbaranes});
                                                        };
                                                        reader.readAsDataURL(file);
                                                    });
                                                    e.target.value = '';
                                                }}
                                                className="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-blue-50"
                                            />
                                        </div>

                                        {/* Seleccionar archivo existente */}
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Seleccionar archivo existente:</label>
                                            <input
                                                type="file"
                                                multiple
                                                accept="image/*,application/pdf,.pdf,.doc,.docx,.xls,.xlsx,.txt"
                                                onChange={(e) => {
                                                    const files = Array.from(e.target.files);
                                                    files.forEach(file => {
                                                        const reader = new FileReader();
                                                        reader.onload = (event) => {
                                                            const newAlbaran = {
                                                                name: file.name,
                                                                url: event.target.result,
                                                                data: event.target.result,
                                                                size: file.size,
                                                                type: file.type,
                                                                category: file.type.startsWith('image/') ? 'imagen' : 'documento'
                                                            };
                                                            const currentAlbaranes = formData.albaranes || [];
                                                            const newAlbaranes = [...currentAlbaranes, newAlbaran];
                                                            setFormData({...formData, albaranes: newAlbaranes});
                                                        };
                                                        reader.readAsDataURL(file);
                                                    });
                                                    e.target.value = '';
                                                }}
                                                className="w-full p-3 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 bg-green-50"
                                            />
                                        </div>
                                    </div>

                                    {/* Informaci√≥n sobre tipos de archivo */}
                                    <div className="bg-gray-50 p-3 rounded-lg">
                                        <p className="text-xs text-gray-600">
                                            üí° <strong>Tipos admitidos:</strong> Im√°genes (JPG, PNG, etc.), PDF, Word, Excel, archivos de texto
                                        </p>
                                    </div>

                                    {formData.albaranes && formData.albaranes.length > 0 && (
                                        <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                                            {formData.albaranes.map((albaran, index) => (
                                                <div key={index} className="relative border rounded-lg overflow-hidden bg-gray-50">
                                                    <img
                                                        src={albaran.url}
                                                        alt={albaran.name}
                                                        className="w-full h-32 object-cover"
                                                    />
                                                    <div className="absolute top-2 right-2">
                                                        <button
                                                            onClick={() => {
                                                                const newAlbaranes = formData.albaranes.filter((_, i) => i !== index);
                                                                setFormData({...formData, albaranes: newAlbaranes});
                                                            }}
                                                            className="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600"
                                                            title="Eliminar albar√°n"
                                                        >
                                                            ‚úï
                                                        </button>
                                                    </div>
                                                    <div className="p-2">
                                                        <p className="text-xs text-gray-600 truncate">{albaran.name}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        );

                    case 8: // Resumen final
                        const totalHoras = formData.operarios.reduce((sum, op) => sum + (parseFloat(op.horas) || 0), 0);
                        return (
                            <div className="space-y-6">
                                <div className="bg-blue-50 p-6 rounded-lg border-2 border-blue-200">
                                    <h4 className="font-semibold text-blue-800 mb-3">üìä Estad√≠sticas del Parte</h4>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                        <div className="text-center">
                                            <div className="font-bold text-lg text-blue-600">
                                                {totalHoras}h
                                            </div>
                                            <div className="text-gray-600">Horas Totales</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="font-bold text-lg text-green-600">{formData.operarios.length}</div>
                                            <div className="text-gray-600">Operarios</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="font-bold text-lg text-orange-600">
                                                {formData.incidencias ? 'Con Incidencias' : 'Sin Incidencias'}
                                            </div>
                                            <div className="text-gray-600">
                                                {formData.incidencias ? 'Con Incidencias' : 'Sin Incidencias'}
                                            </div>
                                        </div>
                                        <div className="text-center">
                                            <div className="font-bold text-lg text-purple-600">{formData.imagenes.length}</div>
                                            <div className="text-gray-600">Im√°genes</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="font-bold text-lg text-green-600">{formData.albaranes?.length || 0}</div>
                                            <div className="text-gray-600">Albaranes</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex flex-col sm:flex-row gap-3">
                                    <button
                                        onClick={exportToPDF}
                                        className="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 flex items-center justify-center gap-2"
                                    >
                                        üìÑ Descargar PDF
                                    </button>
                                    <button
                                        onClick={sendParte}
                                        className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center justify-center gap-2"
                                    >
                                        {sendMethod === 'email' ? 'üìß Enviar por Email' : 'üì± Enviar por WhatsApp'}
                                    </button>
                                </div>

                                <div className="bg-yellow-50 p-3 rounded-lg">
                                    <p className="text-sm text-yellow-700">
                                        üí° <strong>Tip:</strong> Al enviar se crear√° autom√°ticamente un nuevo parte y este se guardar√° en el historial.
                                    </p>
                                </div>
                            </div>
                        );

                    default:
                        return null;
                }
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-4xl mx-auto px-4 py-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-xl sm:text-2xl font-bold text-green-700">üì± Partes de Trabajo M√≥vil</h1>
                                    <p className="text-sm text-gray-600">App offline para partes diarios</p>
                                </div>
                                <div className="flex items-center gap-2">
                                    <SaveStatusIndicator />
                                </div>
                            </div>

                            {/* Botones de navegaci√≥n */}
                            <div className="mt-4 flex flex-wrap gap-2">
                                <button
                                    onClick={() => setShowHistory(true)}
                                    className="px-3 py-2 sm:py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm"
                                >
                                    üìö Historial ({partesHistory.length})
                                </button>
                                <button
                                    onClick={() => setShowSettings(true)}
                                    className="px-3 py-2 sm:py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm"
                                >
                                    ‚öôÔ∏è Configuraci√≥n
                                </button>
                                <button
                                    onClick={createNewParte}
                                    className="px-3 py-2 sm:py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm"
                                >
                                    ‚ûï Nuevo Parte
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Progreso */}
                    <div className="bg-white border-b">
                        <div className="max-w-4xl mx-auto px-4 py-4">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-sm font-medium text-gray-700">
                                    Paso {currentStep + 1} de {steps.length}
                                </span>
                                <span className="text-sm text-gray-500">
                                    {Math.round(((currentStep + 1) / steps.length) * 100)}%
                                </span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                                <div
                                    className="bg-green-600 h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${((currentStep + 1) / steps.length) * 100}%` }}
                                ></div>
                            </div>
                            <p className="text-lg font-semibold text-gray-800 mt-3">
                                {steps[currentStep]}
                            </p>
                        </div>
                    </div>

                    {/* Contenido principal */}
                    <div className="max-w-4xl mx-auto px-4 py-6">
                        <div className="bg-white rounded-lg shadow-sm border p-6">
                            {renderStep()}

                            {/* Navegaci√≥n */}
                            <div className="flex justify-between mt-8">
                                <button
                                    onClick={prevStep}
                                    disabled={currentStep === 0}
                                    className={`px-6 py-3 rounded-lg ${
                                        currentStep === 0
                                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                            : 'bg-gray-600 text-white hover:bg-gray-700'
                                    }`}
                                >
                                    ‚Üê Anterior
                                </button>

                                <button
                                    onClick={nextStep}
                                    disabled={currentStep === steps.length - 1}
                                    className={`px-6 py-3 rounded-lg ${
                                        currentStep === steps.length - 1
                                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                            : 'bg-blue-600 text-white hover:bg-blue-700'
                                    }`}
                                >
                                    Siguiente ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Modal de Configuraci√≥n */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
                            <div className="bg-white rounded-lg max-w-md w-full max-h-[90vh] sm:max-h-[80vh] overflow-y-auto">
                                <div className="p-4 sm:p-6 border-b">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-lg sm:text-xl font-bold text-green-700">‚öôÔ∏è Configuraci√≥n M√≥vil</h3>
                                        <button
                                            onClick={() => setShowSettings(false)}
                                            className="px-3 py-2 sm:px-4 sm:py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm sm:text-base"
                                        >
                                            ‚ùå
                                        </button>
                                    </div>
                                </div>

                                <div className="p-4 sm:p-6 space-y-4 sm:space-y-6">
                                    {/* Configuraci√≥n de Env√≠o */}
                                    <div className="bg-green-50 p-4 sm:p-6 rounded-lg border-2 border-green-200">
                                        <h4 className="font-bold mb-3 sm:mb-4 text-green-800 text-base sm:text-lg">üì± Configuraci√≥n de Env√≠o</h4>

                                        <div className="space-y-4">
                                            {/* M√©todo de env√≠o */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    M√©todo de env√≠o preferido:
                                                </label>
                                                <select
                                                    value={sendMethod}
                                                    onChange={(e) => setSendMethod(e.target.value)}
                                                    className="w-full px-4 py-3 border-2 border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                >
                                                    <option value="email">üìß Email</option>
                                                    <option value="whatsapp">üì± WhatsApp</option>
                                                </select>
                                            </div>

                                            {/* Configuraci√≥n Email */}
                                            {sendMethod === 'email' && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        Tu email:
                                                    </label>
                                                    <input
                                                        type="email"
                                                        value={userEmail}
                                                        onChange={(e) => setUserEmail(e.target.value)}
                                                        placeholder="tu@email.com"
                                                        className="w-full px-4 py-3 border-2 border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                    />
                                                </div>
                                            )}

                                            {/* Configuraci√≥n WhatsApp */}
                                            {sendMethod === 'whatsapp' && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        Tu n√∫mero de WhatsApp:
                                                    </label>
                                                    <input
                                                        type="tel"
                                                        value={userWhatsApp}
                                                        onChange={(e) => setUserWhatsApp(e.target.value)}
                                                        placeholder="+34 123 456 789"
                                                        className="w-full px-4 py-3 border-2 border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                    />
                                                    <p className="text-xs text-gray-600 mt-1">
                                                        Incluye el c√≥digo de pa√≠s (ej: +34 para Espa√±a)
                                                    </p>
                                                </div>
                                            )}

                                            {/* Bot√≥n guardar */}
                                            <button
                                                onClick={() => {
                                                    saveMobileConfig(userEmail, userWhatsApp, sendMethod);
                                                    alert('‚úÖ Configuraci√≥n guardada correctamente');
                                                    setShowSettings(false);
                                                }}
                                                className="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm sm:text-base"
                                            >
                                                üíæ Guardar Configuraci√≥n
                                            </button>
                                        </div>
                                    </div>

                                    {/* Informaci√≥n */}
                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                        <h4 className="font-semibold text-blue-800 mb-2">‚ÑπÔ∏è C√≥mo funciona</h4>
                                        <ul className="text-sm text-blue-700 space-y-1">
                                            <li>‚Ä¢ <strong>Email:</strong> Se abre tu app de email con el parte listo</li>
                                            <li>‚Ä¢ <strong>WhatsApp:</strong> Se abre WhatsApp con el resumen preparado</li>
                                            <li>‚Ä¢ <strong>PDF:</strong> Se descarga autom√°ticamente para adjuntar</li>
                                            <li>‚Ä¢ <strong>Offline:</strong> Funciona sin internet, sincroniza despu√©s</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal de Historial */}
                    {showHistory && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
                            <div className="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                                <div className="p-4 sm:p-6 border-b">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-lg sm:text-xl font-bold text-blue-700">üìö Historial de Partes</h3>
                                        <button
                                            onClick={() => setShowHistory(false)}
                                            className="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                                        >
                                            ‚ùå
                                        </button>
                                    </div>
                                </div>

                                <div className="p-4 sm:p-6">
                                    {partesHistory.length === 0 ? (
                                        <div className="text-center py-8">
                                            <p className="text-gray-500">No hay partes guardados en el historial</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {partesHistory.map((parte, index) => (
                                                <div key={parte.id} className="border rounded-lg p-4 bg-gray-50">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <h4 className="font-semibold text-lg">{parte.nombreTrabajo}</h4>
                                                        <span className="text-xs text-gray-500">
                                                            {new Date(parte.fechaCreacion).toLocaleDateString('es-ES')}
                                                        </span>
                                                    </div>

                                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mt-3">
                                                        <div>
                                                            <span className="font-medium">Horas:</span> {parte.operarios.reduce((sum, op) => sum + (parseFloat(op.horas) || 0), 0)}h
                                                        </div>
                                                        <div>
                                                            <span className="font-medium">Operarios:</span> {parte.operarios.length}
                                                        </div>
                                                        <div>
                                                            <span className="font-medium">Im√°genes:</span> {parte.imagenes?.length || 0}
                                                        </div>
                                                        <div>
                                                            <span className="font-medium">Fecha:</span> {parte.fecha}
                                                        </div>
                                                    </div>

                                                    <div className="mt-3 flex gap-2">
                                                        <button
                                                            onClick={() => {
                                                                setFormData(parte);
                                                                setShowHistory(false);
                                                                setCurrentStep(0);
                                                            }}
                                                            className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm"
                                                        >
                                                            üëÅÔ∏è Ver/Editar
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                const template = {
                                                                    ...parte,
                                                                    id: 'parte_' + Date.now(),
                                                                    fecha: new Date().toISOString().split('T')[0],
                                                                    imagenes: [],
                                                                    albaranes: [],
                                                                    resumenInteligente: ''
                                                                };
                                                                setFormData(template);
                                                                setShowHistory(false);
                                                                setCurrentStep(0);
                                                            }}
                                                            className="px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm"
                                                        >
                                                            üìã Usar como plantilla
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<PartesDiarioApp />, document.getElementById('root'));
    </script>
</body>
</html>